esphome:
  name: countdowner
  friendly_name: CountDowner

esp8266:
  board: nodemcuv2

# Enable logging
logger:

# Enable Home Assistant API
# api:
#   encryption:
#     key: "YPtluhKvx5lOPq3uYO4huMizLiZNXU3N5s7g1vk6woA="

ota:
  - platform: esphome
    password: "4684c4d0cca45e993aa891fea83ae2cc"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  use_address: 192.168.1.95
  fast_connect: True
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Countdowner Fallback Hotspot"
    password: "5ZvfscdxmTVM"

captive_portal:
# Signal sensor to monitor connection quality in the Web UI
sensor:
  - platform: wifi_signal
    name: "WiFi Signal Strength"
    update_interval: 60s

output:
  - platform: esp8266_pwm
    pin: D1
    id: buzzer_out
  - platform: gpio
    pin:
      number: GPIO2
      inverted: true # Active-low for most ESP8266 onboard LEDs
    id: onboard_led

# Global to track blink timing
globals:
  - id: last_blink
    type: uint32_t
    initial_value: '0'
  - id: fake_time_offset
    type: long
    initial_value: '0'
  - id: holiday_played
    type: bool
    initial_value: 'false'

time:
  - platform: sntp
    id: sntp_time
    timezone: "GMT0BST,M3.5.0/1,M10.5.0"
    servers:
      - 0.uk.pool.ntp.org

rtttl:
  output: buzzer_out
  id: my_buzzer

button:
  - platform: template
    name: "Play Jingle Bells"
    icon: "mdi:music-note"
    on_press:
      - rtttl.play: "JingleBells:d=8,o=5,b=125:4e,4e,2e,4e,4e,2e,4e,4g,4c,4d,1e"
  - platform: restart
    name: "Reboot Device"
    icon: "mdi:restart"

switch:
  - platform: template
    name: "Display Power"
    id: display_toggle
    optimistic: true
    restore_mode: ALWAYS_ON
    
  - platform: template
    name: "Test Mode (100x Speed)"
    id: test_mode
    optimistic: true
    on_turn_off:
      lambda: 'id(fake_time_offset) = 0;'

text_sensor:
  - platform: template
    name: "Seconds to Christmas"
    id: seconds_left

web_server:
  port: 80
  version: 3
  ota: false    
  log: False

spi:
  clk_pin: D7
  mosi_pin: D8

display:
  - platform: max7219
    cs_pin: D6
    num_chips: 1
    lambda: |-
      auto now = id(sntp_time).now();
       if (now.is_valid()) {
        if (id(test_mode).state) {
          id(fake_time_offset) += 3600; 
        }
        
        time_t current_epoch = now.timestamp + id(fake_time_offset);
        struct tm target;
        gmtime_r(&current_epoch, &target);
        target.tm_mon = 11;
        target.tm_mday = 25;
        target.tm_hour = 0;
        target.tm_min = 0;
        target.tm_sec = 0;
        target.tm_isdst = -1;
        
        time_t target_epoch = mktime(&target);
        
        if (current_epoch > target_epoch) {
          target.tm_year += 1;
          target_epoch = mktime(&target);
        }

        long seconds_remaining = target_epoch - current_epoch;
        id(seconds_left).publish_state(to_string(seconds_remaining));
        if (id(display_toggle).state) {
          if (now.hour >= 22 || now.hour < 7) {
            it.set_intensity(1); 
          } else {
            it.set_intensity(15);
          }
           it.printf("%08ld", seconds_remaining);
          } 
        }

